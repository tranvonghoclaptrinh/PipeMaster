<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pipe Master Pro - Giftcode Update</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <style>
        @keyframes rainbowBorder {
            0% { border-color: #ff0000; box-shadow: 0 0 16px rgba(255, 0, 0, 0.7), 0 0 32px rgba(255, 0, 0, 0.4); }
            16.67% { border-color: #ff7f00; box-shadow: 0 0 16px rgba(255, 127, 0, 0.7), 0 0 32px rgba(255, 127, 0, 0.4); }
            33.33% { border-color: #ffff00; box-shadow: 0 0 16px rgba(255, 255, 0, 0.7), 0 0 32px rgba(255, 255, 0, 0.4); }
            50% { border-color: #00ff00; box-shadow: 0 0 16px rgba(0, 255, 0, 0.7), 0 0 32px rgba(0, 255, 0, 0.4); }
            66.67% { border-color: #0000ff; box-shadow: 0 0 16px rgba(0, 0, 255, 0.7), 0 0 32px rgba(0, 0, 255, 0.4); }
            83.33% { border-color: #4b0082; box-shadow: 0 0 16px rgba(75, 0, 130, 0.7), 0 0 32px rgba(75, 0, 130, 0.4); }
            100% { border-color: #ff0000; box-shadow: 0 0 16px rgba(255, 0, 0, 0.7), 0 0 32px rgba(255, 0, 0, 0.4); }
        }
        .rainbow-border {
            animation: rainbowBorder 6s linear infinite;
            max-height: 90vh;
            max-width: min(90vh, 90vw);
            aspect-ratio: 1/1;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useMemo, useRef } = React;
        const getSaveKey = (playerName) => `pipe_master_save_${playerName}`;
// ===== AUDIO SYSTEM =====
        const AUDIO = {
            rotate: new Audio("audio/xoayong.mp3"),
            break: new Audio("audio/break.mp3"),
            complete: new Audio("audio/complete.mp3"),
            hint: new Audio("audio/hint.mp3"),
            click: new Audio("audio/click.mp3"),
            win: new Audio("audio/win.mp3"),
            breakrock: new Audio("audio/breakrock.mp3"),
            error: new Audio("audio/error.mp3"),
            background: new Audio("audio/background.mp3"),
            gameplay: new Audio("audio/gameplay.mp3")
        };

        function playSound(name, volume = 1) {
            const a = AUDIO[name];
            if (!a) return;
            a.pause();
            a.currentTime = 0;
            a.volume = volume;
            a.play().catch(()=>{});
        }

        // hint ƒë·∫∑c bi·ªát ‚Üí hint xong m·ªõi break
        function playHintBreak() {
            const hint = AUDIO.hint;
            const br = AUDIO.break;

            hint.pause();
            hint.currentTime = 0;
            hint.volume = 1;
            hint.play().catch(()=>{});

            hint.onended = () => {
                br.pause();
                br.currentTime = 0;
                br.volume = 1;
                br.play().catch(()=>{});
            };
        }
        function playCompleteThenWin() {

            const complete = AUDIO.complete;
            const win = AUDIO.win;

            // reset complete
            complete.pause();
            complete.currentTime = 0;
            complete.volume = 1;

            // khi complete k·∫øt th√∫c ‚Üí ph√°t win
            complete.onended = () => {
                win.pause();
                win.currentTime = 0;
                win.volume = 1;
                win.play().catch(()=>{});
            };

            complete.play().catch(()=>{});
        }
        function playBackground() {
            const bg = AUDIO.background;
            bg.loop = true;
            bg.volume = 0.5;
            bg.play().catch(()=>{});
        }

        function stopBackground() {
            const bg = AUDIO.background;
            bg.pause();
            bg.currentTime = 0;
        }

        function playGameplay() {
            const gm = AUDIO.gameplay;
            gm.loop = true;
            gm.volume = 0.6;
            gm.play().catch(()=>{});
        }

        function stopGameplay() {
            const gm = AUDIO.gameplay;
            gm.pause();
            gm.currentTime = 0;
        }

        const GRID_SIZE = 15; 
        const WIN_BONUS = 800; 
        const COIN_VALUE = 50;
        const SHOVEL_PRICE = 100;
        const REQUIRED_COINS_COUNT = 30; 
        const PIPE_TYPES = ['STRAIGHT', 'ELBOW', 'TEE', 'CROSS'];
        const PIPE_CONNS = {
            SOURCE: [0, 1, 0, 0], 
            SINK: [0, 0, 0, 1], 
            STRAIGHT: [0, 1, 0, 1], 
            ELBOW: [0, 1, 1, 0], 
            TEE: [0, 1, 1, 1], 
            CROSS: [1, 1, 1, 1],
            DIRT: [0, 0, 0, 0]
        };

        const GIFT_CODES = {
            'PIPEMASTER': { coins: 2000, msg: "Qu√† t·∫∑ng Pipe Master! Nh·∫≠n 2000 xu." },
            'FREE800': { coins: 800, msg: "Nh·∫≠n 800 xu mi·ªÖn ph√≠!" },
            'NEWGAME': { coins: 500, msg: "Ch√†o m·ª´ng ng∆∞·ªùi ch∆°i m·ªõi! Nh·∫≠n 500 xu." }
        };

        const App = () => {
            const [playerName, setPlayerName] = useState("");
            const [isLoggedIn, setIsLoggedIn] = useState(false);
            const [totalCoins, setTotalCoins] = useState(12840);
            const [shovelCount, setShovelCount] = useState(0);
            const [sessionCoins, setSessionCoins] = useState(0);
            const [isPlaying, setIsPlaying] = useState(false);
            const [isShopOpen, setIsShopOpen] = useState(false);
            const [isMenuOpen, setIsMenuOpen] = useState(false);
            const [gameGrid, setGameGrid] = useState([]);
            const [isWon, setIsWon] = useState(false);
            const [isLost, setIsLost] = useState(false);
            const [isTutorial, setIsTutorial] = useState(false);
            const [showTutorialModal, setShowTutorialModal] = useState(false);
            const [toast, setToast] = useState(null);
            const [highlightedCells, setHighlightedCells] = useState([]);
            const [buyQuantity, setBuyQuantity] = useState(1);
            const [giftCodeInput, setGiftCodeInput] = useState("");
            const [usedCodes, setUsedCodes] = useState([]);
            const [hasSaved, setHasSaved] = useState(false);
            const [tutorialRock, setTutorialRock] = React.useState(null);

            const [isAIVisible, setIsAIVisible] = useState(false);

            // NEW MENU STATES
            const [mailOpen, setMailOpen] = useState(false);
            const [notificationsOpen, setNotificationsOpen] = useState(false);
            const [currentTime, setCurrentTime] = useState(new Date());
            const [leaderboard, setLeaderboard] = useState([]);
            const [dailyMissions, setDailyMissions] = useState([]);
            const [weeklyMissions, setWeeklyMissions] = useState([]);
            const [leaderboardExpanded, setLeaderboardExpanded] = useState(false);
            const [missionView, setMissionView] = useState("daily");
            const [remainingDaily, setRemainingDaily] = useState("24h : 00m");
            const [remainingWeekly, setRemainingWeekly] = useState("6d : 00h");

            const toggleAI = () => {
                setIsAIVisible(prev => !prev);
                if (!isAIVisible) {
                    runAISolver();
                }
            };

            // MAIL SYSTEM
            const loadMails = () => {
                const mails = [
                    { id: 1, title: "üéâ Ch√†o m·ª´ng", description: "Ch√†o m·ª´ng b·∫°n ƒë·∫øn v·ªõi Pipe Master Pro! Nh·∫≠n 100 xu qu√† t·∫∑ng.", time: "2 gi·ªù tr∆∞·ªõc", coins: 100 },
                    { id: 2, title: "üÜï Giftcode T√¢n th·ªß", description: "S·ª≠ d·ª•ng m√£ NEWGAME ƒë·ªÉ nh·∫≠n 500 xu bonus d√†nh ri√™ng cho ng∆∞·ªùi ch∆°i m·ªõi.", time: "1 gi·ªù tr∆∞·ªõc", coins: 500 },
                    { id: 3, title: "üì¢ Th√¥ng b√°o h·ªá th·ªëng", description: "C∆° ch·∫ø ch∆°i ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t. H√£y kh√°m ph√° c√°c t√≠nh nƒÉng m·ªõi!", time: "H√¥m nay", coins: 0 }
                ];
                return mails;
            };

            const claimMail = (mailId) => {
                const claimedMails = JSON.parse(localStorage.getItem(`claimed_mails_${playerName}`) || "[]");
                if (!claimedMails.includes(mailId)) {
                    claimedMails.push(mailId);
                    localStorage.setItem(`claimed_mails_${playerName}`, JSON.stringify(claimedMails));
                    const mail = loadMails().find(m => m.id === mailId);
                    if (mail && mail.coins > 0) {
                        setTotalCoins(prev => prev + mail.coins);
                        showToast(`ƒê√£ nh·∫≠n ${mail.coins} xu t·ª´ h√≤m th∆∞!`, "success");
                    }
                    return true;
                }
                return false;
            };

            // MISSION SYSTEM
            const initializeMissions = () => {
                const lastResetDaily = localStorage.getItem(`last_reset_daily_${playerName}`);
                const lastResetWeekly = localStorage.getItem(`last_reset_weekly_${playerName}`);
                const now = Date.now();
                const oneDay = 24 * 60 * 60 * 1000;
                const oneWeek = 7 * 24 * 60 * 60 * 1000;

                let daily = JSON.parse(localStorage.getItem(`missions_daily_${playerName}`) || "null");
                let weekly = JSON.parse(localStorage.getItem(`missions_weekly_${playerName}`) || "null");

                if (!lastResetDaily || (now - parseInt(lastResetDaily)) > oneDay) {
                    daily = [
                        { id: "d1", title: "Ch∆°i 1 tr·∫≠n", progress: 0, target: 1, reward: 50, claimed: false },
                        { id: "d2", title: "Thu th·∫≠p 500 xu", progress: 0, target: 500, reward: 100, claimed: false },
                        { id: "d3", title: "S·ª≠ d·ª•ng Giftcode", progress: 0, target: 1, reward: 75, claimed: false }
                    ];
                    localStorage.setItem(`missions_daily_${playerName}`, JSON.stringify(daily));
                    localStorage.setItem(`last_reset_daily_${playerName}`, now.toString());
                }

                if (!lastResetWeekly || (now - parseInt(lastResetWeekly)) > oneWeek) {
                    weekly = [
                        { id: "w1", title: "Th·∫Øng 3 tr·∫≠n", progress: 0, target: 3, reward: 300, claimed: false },
                        { id: "w2", title: "Thu th·∫≠p 3000 xu", progress: 0, target: 3000, reward: 500, claimed: false }
                    ];
                    localStorage.setItem(`missions_weekly_${playerName}`, JSON.stringify(weekly));
                    localStorage.setItem(`last_reset_weekly_${playerName}`, now.toString());
                }

                setDailyMissions(daily);
                setWeeklyMissions(weekly);
            };

            const updateMissionProgress = (missionId, amount = 1, isWeekly = false) => {
                const missions = isWeekly ? weeklyMissions : dailyMissions;
                const mission = missions.find(m => m.id === missionId);
                if (mission && !mission.claimed) {
                    mission.progress = Math.min(mission.progress + amount, mission.target);
                    if (isWeekly) {
                        setWeeklyMissions([...missions]);
                        localStorage.setItem(`missions_weekly_${playerName}`, JSON.stringify(missions));
                    } else {
                        setDailyMissions([...missions]);
                        localStorage.setItem(`missions_daily_${playerName}`, JSON.stringify(missions));
                    }
                }
            };

            const claimMission = (missionId, isWeekly) => {
                const missions = isWeekly ? weeklyMissions : dailyMissions;
                const mission = missions.find(m => m.id === missionId);
                if (mission && !mission.claimed && mission.progress >= mission.target) {
                    mission.claimed = true;
                    setTotalCoins(prev => prev + mission.reward);
                    showToast(`Nh·∫≠n ${mission.reward} xu t·ª´ nhi·ªám v·ª•!`, "success");
                    if (isWeekly) {
                        setWeeklyMissions([...missions]);
                        localStorage.setItem(`missions_weekly_${playerName}`, JSON.stringify(missions));
                    } else {
                        setDailyMissions([...missions]);
                        localStorage.setItem(`missions_daily_${playerName}`, JSON.stringify(missions));
                    }
                }
            };

            // Auto-reload missions when time resets
            useEffect(() => {
                if (isLoggedIn && !isPlaying) {
                    initializeMissions();
                }
            }, [isLoggedIn, isPlaying]);

            // LEADERBOARD SYSTEM
            const loadLeaderboard = () => {
                let fakeLeaderboard = [
                    { rank: 1, name: "Alex", coins: 40000, medal: "ü•á" },
                    { rank: 2, name: "John", coins: 35000, medal: "ü•à" },
                    { rank: 3, name: "Lina", coins: 32000, medal: "ü•â" }
                ];

                // Ki·ªÉm tra n·∫øu ng∆∞·ªùi ch∆°i hi·ªán t·∫°i c√≥ nhi·ªÅu coins h∆°n rank #3
                if (isLoggedIn && totalCoins > fakeLeaderboard[2].coins) {
                    // T√¨m v·ªã tr√≠ ƒë·ªÉ insert ng∆∞·ªùi ch∆°i
                    let insertIndex = fakeLeaderboard.length;
                    for (let i = 0; i < fakeLeaderboard.length; i++) {
                        if (totalCoins > fakeLeaderboard[i].coins) {
                            insertIndex = i;
                            break;
                        }
                    }

                    // T·∫°o ng∆∞·ªùi ch∆°i hi·ªán t·∫°i
                    const currentPlayer = {
                        rank: insertIndex + 1,
                        name: playerName,
                        coins: totalCoins,
                        medal: insertIndex === 0 ? "ü•á" : insertIndex === 1 ? "ü•à" : insertIndex === 2 ? "ü•â" : ""
                    };

                    // Insert v√†o v·ªã tr√≠ ƒë√∫ng v√† c·∫≠p nh·∫≠t rank
                    fakeLeaderboard.splice(insertIndex, 0, currentPlayer);

                    // C·∫≠p nh·∫≠t l·∫°i rank cho c√°c ph·∫ßn t·ª≠ sau
                    for (let i = insertIndex + 1; i < fakeLeaderboard.length; i++) {
                        fakeLeaderboard[i].rank = i + 1;
                        fakeLeaderboard[i].medal = i === 0 ? "ü•á" : i === 1 ? "ü•à" : i === 2 ? "ü•â" : "";
                    }

                    // Ch·ªâ gi·ªØ top 3
                    fakeLeaderboard = fakeLeaderboard.slice(0, 3);
                }

                setLeaderboard(fakeLeaderboard);
            };

            // CLOCK SYSTEM
            useEffect(() => {
                const timer = setInterval(() => {
                    setCurrentTime(new Date());
                }, 1000);
                return () => clearInterval(timer);
            }, []);

            // COUNTDOWN SYSTEM FOR MISSIONS
            useEffect(() => {
                const updateCountdowns = () => {
                    const daily = calculateDailyTimeRemaining();
                    const weekly = calculateWeeklyTimeRemaining();
                    setRemainingDaily(daily);
                    setRemainingWeekly(weekly);

                    // AUTO-RELOAD WHEN TIME EXPIRES
                    if (daily === "0h : 0m" && isLoggedIn) {
                        initializeMissions();
                        showToast("üìÖ Nhi·ªám v·ª• h√†ng ng√†y ƒë√£ reset!", "success");
                    }
                    if (weekly === "0d : 0h" && isLoggedIn) {
                        initializeMissions();
                        showToast("üéØ Nhi·ªám v·ª• h√†ng tu·∫ßn ƒë√£ reset!", "success");
                    }
                };
                updateCountdowns();
                const timer = setInterval(updateCountdowns, 1000);
                return () => clearInterval(timer);
            }, [isLoggedIn]);

            const formatTime = () => {
                const hours = String(currentTime.getHours()).padStart(2, '0');
                const minutes = String(currentTime.getMinutes()).padStart(2, '0');
                const date = String(currentTime.getDate()).padStart(2, '0');
                const month = String(currentTime.getMonth() + 1).padStart(2, '0');
                return `${hours}:${minutes}`;
            };

            const calculateDailyTimeRemaining = () => {
                const now = new Date();
                const tomorrow = new Date(now);
                tomorrow.setDate(tomorrow.getDate() + 1);
                tomorrow.setHours(0, 0, 0, 0);
                const diff = tomorrow - now;
                const hours = Math.floor(diff / (1000 * 60 * 60));
                const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                return `${hours}h : ${minutes}m`;
            };

            const calculateWeeklyTimeRemaining = () => {
                const now = new Date();
                const nextWeek = new Date(now);
                nextWeek.setDate(nextWeek.getDate() + 7);
                nextWeek.setHours(0, 0, 0, 0);
                const diff = nextWeek - now;
                const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                return `${days}d : ${hours}h`;
            };

            // Initialize on login
            useEffect(() => {
                if (isLoggedIn && !isPlaying) {
                    loadLeaderboard();
                    initializeMissions();
                }
            }, [isLoggedIn, isPlaying, totalCoins]);

            const [aiLogs, setAiLogs] = useState([]); // State ƒë·ªÉ l∆∞u log hi·ªÉn th·ªã b√™n ph·∫£i

            // Simple AI solver placeholder
            const attemptedRotations = useRef({});

            const runAISolver = async () => {
                setAiLogs([{time: new Date().toLocaleTimeString(), text: "ü§ñ AI Starting..."}]);

                let iterations = 0;
                const maxIterations = 200;

                while (!isWon && isPlaying && iterations < maxIterations) {
                    iterations++;
                    await new Promise(r => setTimeout(r, 200));

                    const currentGrid = JSON.parse(JSON.stringify(gameGrid));
                    const activeCells = [];
                    currentGrid.forEach(row => row.forEach(cell => {
                        if (cell.active) activeCells.push(cell);
                    }));

                    setAiLogs(prev => [...prev, {time: new Date().toLocaleTimeString(), text: `‚úì Iteration ${iterations}: ${activeCells.length} active pipes`}]);

                    if (isWon) {
                        setAiLogs(prev => [...prev, {time: new Date().toLocaleTimeString(), text: "üéâ Victory!"}]);
                        break;
                    }
                }

                if (iterations >= maxIterations) {
                    setAiLogs(prev => [...prev, {time: new Date().toLocaleTimeString(), text: "‚èπÔ∏è Max iterations reached"}]);
                }
            };
            useEffect(() => {

                // gi·ªØ class body nh∆∞ b·∫°n ƒëang d√πng
                document.body.classList.toggle('game-active', isPlaying);

                // ch∆∞a login ‚Üí kh√¥ng ph√°t g√¨
                if (!isLoggedIn) return;

                if (isPlaying) {

                    // t·∫Øt background
                    AUDIO.background.pause();
                    AUDIO.background.currentTime = 0;

                    // b·∫≠t gameplay
                    AUDIO.gameplay.loop = true;
                    AUDIO.gameplay.volume = 0.6;

                    AUDIO.gameplay.play().catch(()=>{});

                } else {

                    // t·∫Øt gameplay
                    AUDIO.gameplay.pause();
                    AUDIO.gameplay.currentTime = 0;

                    // b·∫≠t background
                    AUDIO.background.loop = true;
                    AUDIO.background.volume = 0.5;

                    AUDIO.background.play().catch(()=>{});

                }

            }, [isPlaying, isLoggedIn]);

const showToast = (message, type = "info") => {

    let bg = "bg-slate-700 text-white";

    if (type === "warning")
        bg = "bg-yellow-400 text-black border-4 border-yellow-600";

    if (type === "error")
        bg = "bg-red-500 text-white border-4 border-red-700";

    if (type === "success")
        bg = "bg-green-500 text-white border-4 border-green-700";


    // container ·ªü TOP, cƒÉn gi·ªØa ngang
    const wrapper = document.createElement("div");
    wrapper.className =
        "fixed inset-x-0 top-6 z-[20000] flex justify-center pointer-events-none";


    const toast = document.createElement("div");
    toast.className =
        `px-10 py-5
         text-xl md:text-2xl
         font-black
         rounded-2xl
         shadow-2xl
         ${bg}
         animate-bounce`;

    toast.innerHTML = message;

    wrapper.appendChild(toast);
    document.body.appendChild(wrapper);


    setTimeout(() => {

        toast.style.opacity = "0";
        toast.style.transform = "translateY(-10px) scale(0.95)";
        toast.style.transition = "all 0.3s";

        setTimeout(() => wrapper.remove(), 300);

    }, 2000);
};

            const handleLogin = (e) => {

                e.preventDefault();

                playSound("click", 0.5);

                if (playerName.trim().length >= 2) {

                    setIsLoggedIn(true);

                    AUDIO.background.loop = true;
                    AUDIO.background.volume = 0.5;

                    AUDIO.background.play().catch(()=>{});
                }
            };

            const handleRedeemGiftcode = () => {
                const code = giftCodeInput.trim().toUpperCase();
                if (!code) return;

                if (usedCodes.includes(code)) {
                    showToast("M√£ n√†y ƒë√£ ƒë∆∞·ª£c s·ª≠ d·ª•ng!", "error");
                    return;
                }

                if (GIFT_CODES[code]) {
                    const gift = GIFT_CODES[code];
                    setTotalCoins(prev => prev + gift.coins);
                    setUsedCodes(prev => [...prev, code]);
                    setGiftCodeInput("");
                    showToast(gift.msg, "success");

                    // UPDATE MISSIONS
                    updateMissionProgress("d3", 1, false); // S·ª≠ d·ª•ng Giftcode
                } else {
                    showToast("M√£ Giftcode kh√¥ng h·ª£p l·ªá!", "error");
                }
            };

            const getRandomPipe = () => PIPE_TYPES[Math.floor(Math.random() * PIPE_TYPES.length)];

            const findPathAStar = (grid, ignoreDirt = false) => {
                const start = { r: 0, c: 0 };
                const goal = { r: GRID_SIZE - 1, c: GRID_SIZE - 1 };
                const h = (pos) => Math.abs(pos.r - goal.r) + Math.abs(pos.c - goal.c);
                const openSet = [{ ...start, g: 0, f: h(start), path: [start] }];
                const closedSet = new Set();

                while (openSet.length > 0) {
                    openSet.sort((a, b) => a.f - b.f);
                    const current = openSet.shift();
                    const key = `${current.r},${current.c}`;
                    if (current.r === goal.r && current.c === goal.c) return current.path;
                    closedSet.add(key);
                    const dirs = [[-1, 0], [1, 0], [0, -1], [0, 1]];
                    for (let [dr, dc] of dirs) {
                        const nr = current.r + dr, nc = current.c + dc;
                        if (nr < 0 || nr >= GRID_SIZE || nc < 0 || nc >= GRID_SIZE) continue;
                        if (closedSet.has(`${nr},${nc}`)) continue;
                        if (!ignoreDirt && grid[nr][nc].type === 'DIRT') continue;
                        const weight = grid[nr][nc].type === 'DIRT' ? 10 : 1;
                        const tentativeG = current.g + weight;
                        const existing = openSet.find(o => o.r === nr && o.c === nc);
                        if (!existing || tentativeG < existing.g) {
                            const node = { r: nr, c: nc, g: tentativeG, f: tentativeG + h({r:nr, c:nc}), path: [...current.path, {r:nr, c:nc}] };
                            if (!existing) openSet.push(node);
                            else Object.assign(existing, node);
                        }
                    }
                }
                return null;
            };

            const checkLoseCondition = (grid, coins, shovels) => {
                if (shovels > 0 || coins >= SHOVEL_PRICE) return;
                let coinAvailable = false;
                grid.forEach(row => row.forEach(cell => {
                    if (cell.hasCoin) coinAvailable = true;
                }));
                if (coinAvailable) return;
                setIsLost(true);
            };

            const triggerHighlight = (cells) => {
                const coords = cells.map(c => `${c.r}-${c.c}`);
                setHighlightedCells(coords);
                setTimeout(() => setHighlightedCells([]), 3100);
            };

            const handleFlushHint = () => {
                if (sessionCoins < 50) {
                    showToast("C·∫ßn √≠t nh·∫•t 50 xu!", "error");
                    return;
                }

                let newGrid = JSON.parse(JSON.stringify(gameGrid));
                let highlightTargets = [];
                let spent = 0;
                let msg = "";

                if (sessionCoins >= 1000) {
                    msg = "K√çCH HO·∫†T: Auto-Win Tuy·∫øn Ch√≠nh!";
                    const path = findPathAStar(newGrid, true);
                    if(path) {
                        path.forEach(p => {
                            if(newGrid[p.r][p.c].type === 'DIRT') newGrid[p.r][p.c].type = 'STRAIGHT';
                        });
                    }
                    spent = Math.min(sessionCoins, 1400);
                } else if (sessionCoins >= 700) {
                    msg = "K√çCH HO·∫†T: Ph√° h·ªßy v√πng 7x7 g√≥c Sink!";
                    const startR = GRID_SIZE - 7;
                    const startC = GRID_SIZE - 7;
                    for (let r = startR; r < GRID_SIZE; r++) {
                        for (let c = startC; c < GRID_SIZE; c++) {
                            highlightTargets.push({r, c});
                            if (newGrid[r][c].type === 'DIRT') {
                                newGrid[r][c].type = getRandomPipe();
                            }
                        }
                    }
                    triggerHighlight(highlightTargets);
                    spent = sessionCoins;
                } else if (sessionCoins >= 400) {
                    msg = "K√çCH HO·∫†T: D·ªçn v√πng 5x10 ti·ªÅm nƒÉng!";
                    let bestRegion = {r: 0, c: 0, count: -1};
                    for(let r=0; r<=GRID_SIZE-5; r++) {
                        for(let c=0; c<=GRID_SIZE-10; c++) {
                            let count = 0;
                            for(let ir=r; ir<r+5; ir++) for(let ic=c; ic<c+10; ic++) if(newGrid[ir][ic].type === 'DIRT') count++;
                            if(count > bestRegion.count) bestRegion = {r, c, count};
                        }
                    }
                    for(let r=bestRegion.r; r<bestRegion.r+5; r++) {
                        for(let c=bestRegion.c; c<bestRegion.c+10; c++) {
                            highlightTargets.push({r, c});
                            if(newGrid[r][c].type === 'DIRT') newGrid[r][c].type = getRandomPipe();
                        }
                    }
                    triggerHighlight(highlightTargets);
                    spent = sessionCoins;
                } else if (sessionCoins >= 200) {
                    msg = "K√çCH HO·∫†T: Ph√° 3 √¥ ƒë√° g·∫ßn n∆∞·ªõc nh·∫•t!";
                    const activeCells = [];
                    newGrid.forEach(row => row.forEach(c => { if(c.active) activeCells.push(c); }));
                    const dirts = [];
                    newGrid.forEach(row => row.forEach(c => { if(c.type === 'DIRT') dirts.push(c); }));
                    const scored = dirts.map(d => {
                        let min = 99;
                        activeCells.forEach(a => { const dist = Math.abs(d.r-a.r)+Math.abs(d.c-a.c); if(dist < min) min = dist; });
                        return { ...d, score: min };
                    }).sort((a,b) => a.score - b.score).slice(0, 3);
                    scored.forEach(t => {
                        highlightTargets.push({r: t.r, c: t.c});
                        newGrid[t.r][t.c].type = getRandomPipe();
                    });
                    triggerHighlight(highlightTargets);
                    spent = sessionCoins;
                } else {
                    msg = "K√çCH HO·∫†T: Ph√° 1 √¥ ƒë√° g·∫ßn n∆∞·ªõc!";
                    const activeCells = [];
                    newGrid.forEach(row => row.forEach(c => { if(c.active) activeCells.push(c); }));
                    let best = null, minDist = 99;
                    newGrid.forEach(row => row.forEach(c => {
                        if(c.type === 'DIRT') {
                            activeCells.forEach(a => {
                                const d = Math.abs(c.r-a.r)+Math.abs(c.c-a.c);
                                if(d < minDist) { minDist = d; best = c; }
                            });
                        }
                    }));
                    if(best) {
                        highlightTargets.push({r: best.r, c: best.c});
                        newGrid[best.r][best.c].type = getRandomPipe();
                        triggerHighlight(highlightTargets);
                    }
                    spent = sessionCoins;
                }

                const finalCoins = sessionCoins - spent;
                setSessionCoins(finalCoins);
                setGameGrid(newGrid);
                updateFlow(newGrid, finalCoins, shovelCount);
                showToast(msg, "success");
                playHintBreak();
                setIsShopOpen(false);
            };

            const buyShovels = () => {
                const qty = parseInt(buyQuantity) || 1;
                const totalCost = qty * SHOVEL_PRICE;
                if (qty < 1) { showToast("S·ªë l∆∞·ª£ng ph·∫£i √≠t nh·∫•t l√† 1!", "error"); return; }
                if (sessionCoins >= totalCost) {
                    setSessionCoins(prev => prev - totalCost);
                    setShovelCount(prev => prev + qty);
                    showToast(`ƒê√£ mua ${qty} X·∫ªng!`, "success");
                    setBuyQuantity(1); 
                } else { showToast("Kh√¥ng ƒë·ªß xu!", "error"); }
            };

            const generatePuzzle = (keepCoins = false) => {
                setHasSaved(false);
                const size = GRID_SIZE;
                const grid = Array(size).fill(null).map((_, r) => 
                    Array(size).fill(null).map((_, c) => ({
                        r, c, type: 'STRAIGHT', rotation: 0, 
                        isFixed: false, active: false, hasCoin: false
                    }))
                );
                grid[0][0].type = 'SOURCE'; grid[0][0].isFixed = true;
                grid[0][1].type = 'DIRT'; grid[0][1].isTutorialBlock = true;
                grid[size-1][size-1].type = 'SINK'; grid[size-1][size-1].isFixed = true;
                
                const dirtCount = Math.floor(size * size * 0.38); 
                let placedDirt = 0;
                while(placedDirt < dirtCount) {
                    const r = Math.floor(Math.random() * size), c = Math.floor(Math.random() * size);
                    if (!grid[r][c].isFixed && !grid[r][c].isTutorialBlock && grid[r][c].type !== 'DIRT') {
                        grid[r][c].type = 'DIRT'; placedDirt++;
                    }
                }

                let placedCoins = 0;
                while (placedCoins < REQUIRED_COINS_COUNT) {
                    const r = Math.floor(Math.random() * size);
                    const c = Math.floor(Math.random() * size);
                    if (!grid[r][c].isFixed && !grid[r][c].hasCoin) {
                        grid[r][c].hasCoin = true;
                        placedCoins++;
                    }
                }

                grid.forEach(row => row.forEach(cell => {
                    if (cell.type !== 'DIRT' && !cell.isFixed) {
                        cell.type = getRandomPipe();
                        cell.rotation = Math.floor(Math.random() * 4);
                    }
                }));

                setGameGrid(grid);
                if (!keepCoins) setSessionCoins(0); 
                setIsWon(false); setIsLost(false); setIsTutorial(true); 
                setShowTutorialModal(true); 
                setShovelCount(1); setIsPlaying(true); updateFlow(grid, keepCoins ? sessionCoins : 0, 1);
                setIsMenuOpen(false);
            };

            const getConns = (p) => {
                const base = PIPE_CONNS[p.type] || [0,0,0,0];
                return [...base.slice(4 - p.rotation), ...base.slice(0, 4 - p.rotation)];
            };

            const updateFlow = (grid, currentCoins, currentShovels) => {
                grid.forEach(row => row.forEach(p => p.active = false));
                const queue = [grid[0][0]];
                grid[0][0].active = true;
                let reachedSink = false;
                let collected = 0;

                while (queue.length > 0) {
                    const curr = queue.shift();
                    if (curr.type === 'SINK') reachedSink = true;
                    if (curr.hasCoin && curr.type !== 'DIRT') { 
                        curr.hasCoin = false; 
                        collected += COIN_VALUE; 
                    }
                    const conns = getConns(curr);
                    const dirs = [[-1, 0, 0], [0, 1, 1], [1, 0, 2], [0, -1, 3]];
                    dirs.forEach(([dr, dc, dirIdx]) => {
                        if (conns[dirIdx]) {
                            const nr = curr.r + dr, nc = curr.c + dc;
                            if (nr >= 0 && nr < GRID_SIZE && nc >= 0 && nc < GRID_SIZE) {
                                const neigh = grid[nr][nc];
                                if (!neigh.active && neigh.type !== 'DIRT') {
                                    if (getConns(neigh)[(dirIdx + 2) % 4]) {
                                        neigh.active = true; queue.push(neigh);
                                    }
                                }
                            }
                        }
                    });
                }
                
                const finalCoins = currentCoins + collected;
                if (collected > 0) setSessionCoins(finalCoins);
                setGameGrid([...grid]);
                
                if (reachedSink) {
                    playCompleteThenWin();
                    
                    setTimeout(() => setIsWon(true), 2100);
                } else checkLoseCondition(grid, finalCoins, currentShovels);
            };

            const rotatePipe = (r, c) => {
                playSound("rotate", 0.6);
                if (isWon || isLost) return;
                const pipe = gameGrid[r][c];
                if (pipe.type === 'DIRT') {

                // ‚ùå kh√¥ng c√≥ x·∫ªng ‚Üí ph√°t error
                if (shovelCount <= 0) {

                    playSound("error", 0.6);
                    showToast("H·∫øt x·∫ªng! H√£y v√†o Shop.", "error");

                    // SHAKE √¥ b·ªã click
                    const el = document.getElementById(`pipe-${r}-${c}`);
                    if (el) {
                        el.classList.add("shake");
                        setTimeout(() => el.classList.remove("shake"), 250);
                    }

                    return;
                }

                // ‚úÖ c√≥ x·∫ªng ‚Üí m·ªõi ph√°t breakrock
                playSound("breakrock", 0.8);

                const newGrid = JSON.parse(JSON.stringify(gameGrid));
                newGrid[r][c].type = getRandomPipe();

                const newShovelCount =
                    pipe.isTutorialBlock ? 3 : shovelCount - 1;

                if (pipe.isTutorialBlock) {
                    setIsTutorial(false);
                    showToast("L√†m t·ªët l·∫Øm! Ti·∫øp t·ª•c ph√° ƒë√° v√† d·∫´n n∆∞·ªõc nh√©.", "success");
                }

                setShovelCount(newShovelCount);
                setGameGrid(newGrid);

                updateFlow(newGrid, sessionCoins, newShovelCount);

                return;
            }
                if (pipe.isFixed || isTutorial) return;
                const newGrid = JSON.parse(JSON.stringify(gameGrid));
                newGrid[r][c].rotation = (newGrid[r][c].rotation + 1) % 4;
                updateFlow(newGrid, sessionCoins, shovelCount);
            };

            const saveGame = () => {

                const saveData = {
                    grid: gameGrid,
                    coins: sessionCoins,
                    shovels: shovelCount
                };

                localStorage.setItem(getSaveKey(playerName), JSON.stringify(saveData));
                setHasSaved(true);

                showToast("ƒê√£ l∆∞u tr·∫≠n ƒë·∫•u th√†nh c√¥ng!", "success");

                setIsMenuOpen(false);

                setIsPlaying(false);
            };
            const loadGame = () => {

                const raw = localStorage.getItem(getSaveKey(playerName));

                if (!raw) return false;

                try {

                    const data = JSON.parse(raw);

                    setGameGrid(data.grid);
                    setSessionCoins(data.coins);
                    setShovelCount(data.shovels);

                    setIsPlaying(true);

                    return true;

                } catch {

                    return false;

                }
            };

            const canAfford = sessionCoins >= (buyQuantity * SHOVEL_PRICE);

            if (!isLoggedIn) {
                return (
                    <div className="min-h-screen flex items-center justify-center p-6">
                        <div className="glass-card p-10 max-w-md w-full border-cyan-500/30 text-center animate-in fade-in zoom-in duration-500">
                            <div className="w-20 h-20 bg-cyan-500 rounded-2xl flex items-center justify-center text-4xl mx-auto mb-6 shadow-lg shadow-cyan-500/20">üõ†Ô∏è</div>
                            <div className="flex items-baseline gap-3"><h1 className="text-5xl font-black uppercase italic tracking-tight bg-gradient-to-r from-cyan-300 to-blue-400 bg-clip-text text-transparent" style={{lineHeight:"1.2",paddingRight:"6px",display:"inline-block"}}>PIPEMASTER</h1><span className="text-xl font-black text-cyan-400/80 uppercase tracking-widest">PRO</span></div>
                            
                            <form onSubmit={handleLogin} className="space-y-4 text-left">
                                <div>
                                    <label className="block text-[10px] font-black text-slate-500 uppercase mb-2 tracking-widest">T√™n ng∆∞·ªùi ch∆°i</label>
                                    <input 
                                        type="text" 
                                        required
                                        value={playerName}
                                        onChange={(e) => setPlayerName(e.target.value)}
                                        placeholder="Nh·∫≠p t√™n..."
                                        className="w-full login-input px-5 py-4 rounded-xl text-white font-bold placeholder:text-slate-600"
                                    />
                                </div>
                                <button 
                                    type="submit" 
                                    disabled={playerName.trim().length < 2}
                                    className="play-button w-full py-4 rounded-xl font-black text-lg disabled:opacity-50 disabled:cursor-not-allowed"
                                >
                                    V√ÄO TR√í CH∆†I
                                </button>
                            </form>
                        </div>
                    </div>
                );
            }

            return (
                <div className="p-4 md:p-8 max-w-7xl mx-auto space-y-8">
                    {toast && (
                        <div className="toast-container">
                            <div className={`toast ${toast.type === 'error' ? 'bg-red-600' : 'bg-emerald-600'}`}>
                                <span>{toast.type === 'error' ? '‚ö†Ô∏è' : '‚úÖ'}</span>{toast.message}
                            </div>
                        </div>
                    )}
                    


                    {!isPlaying ? (
                        <div className="space-y-6 min-h-screen relative overflow-hidden">
                            {/* ANIMATED BACKGROUND GRADIENT */}
                            <div className="fixed inset-0 z-0 pointer-events-none">
                                <div className="absolute top-0 left-1/2 -translate-x-1/2 w-96 h-96 bg-cyan-500/10 rounded-full filter blur-3xl animate-pulse" />
                                <div className="absolute bottom-0 right-0 w-96 h-96 bg-blue-500/10 rounded-full filter blur-3xl animate-pulse delay-1000" />
                            </div>

                            {/* TOP BAR */}
                            <div className="relative z-10 backdrop-blur-md border-b border-cyan-500/10 bg-slate-950/40">
                                <div className="max-w-7xl mx-auto px-4 md:px-8 py-4 flex justify-between items-center">
                                    <div className="flex items-center gap-4">
                                        <div className="w-12 h-12 rounded-full bg-gradient-to-br from-cyan-400 to-blue-600 flex items-center justify-center text-2xl shadow-lg shadow-cyan-500/50">üë§</div>
                                        <div>
                                            <p className="text-xs text-slate-400 uppercase tracking-widest font-bold">Player</p>
                                            <p className="text-lg font-black text-cyan-300">{playerName.toUpperCase()}</p>
                                        </div>
                                    </div>

                                    <div className="flex items-center gap-2 justify-center">
                                        
                                            <div className="flex items-baseline gap-3"><h1 className="text-5xl font-black uppercase italic tracking-tight bg-gradient-to-r from-cyan-300 to-blue-400 bg-clip-text text-transparent" style={{lineHeight:"1.2",paddingRight:"6px",display:"inline-block"}}>PIPEMASTER</h1><span className="text-xl font-black text-cyan-400/80 uppercase tracking-widest">PRO</span></div>
                                    </div>

                                    <div className="flex items-center gap-6">
                                        <div className="flex items-center gap-2 bg-slate-900/60 backdrop-blur px-4 py-2 rounded-full border border-cyan-500/20">
                                            <span className="text-2xl">ü™ô</span>
                                            <span className="font-black text-xl text-cyan-300">{totalCoins.toLocaleString()}</span>
                                        </div>

                                        <div className="relative group">
                                            <button onClick={() => {playSound("click", 0.5); setNotificationsOpen(!notificationsOpen);}} className="w-12 h-12 rounded-full bg-gradient-to-br from-purple-500 to-pink-600 flex items-center justify-center text-xl transition-all duration-300 hover:shadow-lg hover:shadow-purple-500/50 active:scale-95 group-hover:scale-110 animate-pulse">üîî</button>
                                        </div>

                                        <button onClick={() => {playSound("click", 0.5); setIsLoggedIn(false); setPlayerName("");}} className="w-12 h-12 rounded-full bg-gradient-to-br from-red-500 to-red-600 flex items-center justify-center text-xl transition-all duration-300 hover:shadow-lg hover:shadow-red-500/50 active:scale-95 hover:scale-110" title="ƒêƒÉng xu·∫•t">üö™</button>
                                    </div>
                                </div>
                            </div>

                            {/* NOTIFICATION MODAL - FIXED AT CENTER */}
                            {notificationsOpen && (
                                <>
                                    <div className="fixed inset-0 z-[9998] bg-black/50 backdrop-blur-sm" onClick={() => setNotificationsOpen(false)} />
                                    <div className="fixed inset-0 z-[9999] flex items-center justify-center p-4">
                                        <div className="w-full max-w-md max-h-[80vh] backdrop-blur-xl border border-purple-500/30 shadow-2xl shadow-purple-500/30 p-8 rounded-3xl bg-gradient-to-b from-slate-900/95 to-slate-950/95 animate-in fade-in zoom-in-95 duration-300 overflow-y-auto">
                                            <div className="flex justify-between items-center mb-6 sticky top-0 bg-gradient-to-b from-slate-900/95 to-slate-950/80 pb-4">
                                                <h3 className="text-2xl font-black text-purple-400 uppercase tracking-tight">üîî Th√¥ng b√°o</h3>
                                                <button onClick={() => setNotificationsOpen(false)} className="text-3xl text-slate-400 hover:text-purple-400 transition-colors">‚úï</button>
                                            </div>
                                            <div className="space-y-3">
                                                <p className="text-sm text-slate-300 mb-3 leading-relaxed">Ch√†o m·ª´ng tr·ªü l·∫°i, <span className="text-cyan-400 font-black">{playerName}</span>! üéÆ</p>
                                                <div className="bg-gradient-to-r from-green-500/20 to-cyan-500/20 border border-green-500/30 rounded-xl p-3">
                                                    <p className="text-sm text-slate-300 font-bold">üìå Giftcode T√¢n Th·ªß</p>
                                                    <p className="text-lg font-black text-green-400 mt-1">NEWGAME</p>
                                                    <p className="text-xs text-slate-400 mt-2">+500 xu cho ng∆∞·ªùi ch∆°i m·ªõi</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </>
                            )}

                            {/* MAIN CONTENT - PERFECT 3 COLUMN GRID */}
                            <div className="relative z-10 max-w-7xl mx-auto px-4 md:px-8 py-8">
                                <div style={{display: 'grid', gridTemplateColumns: '320px 1fr 320px', gap: '32px', alignItems: 'stretch'}}>

                                    {/* LEFT PANEL - LEADERBOARD */}
                                    <div className="space-y-4">
                                        <div className="backdrop-blur-xl border border-cyan-500/20 bg-gradient-to-br from-slate-900/40 to-slate-950/60 rounded-3xl p-6 shadow-2xl shadow-cyan-500/10 hover:shadow-cyan-500/20 transition-all duration-300">
                                            <div className="flex items-center gap-3 mb-6">
                                                <div className="w-10 h-10 rounded-full bg-gradient-to-br from-cyan-400 to-blue-600 flex items-center justify-center text-lg">üèÜ</div>
                                                <h3 className="text-2xl font-black text-cyan-300 uppercase tracking-tight">Rank</h3>
                                            </div>

                                            <div className="space-y-3">
                                                {leaderboard.map((player, idx) => (
                                                    <div key={player.rank} className={`group p-3 rounded-2xl transition-all duration-300 cursor-pointer transform hover:translateY-1 ${idx < 3 ? "bg-gradient-to-r from-slate-800/80 to-slate-800/40 border-2 border-cyan-500/40 hover:border-cyan-500/70 shadow-lg shadow-cyan-500/20 hover:shadow-cyan-500/40" : "bg-slate-800/30 border border-cyan-500/10 hover:border-cyan-500/30"}`}>
                                                        <div className="flex justify-between items-center">
                                                            <div className="flex items-center gap-3 flex-1">
                                                                <span className="text-2xl font-black w-8">{player.medal || `#${player.rank}`}</span>
                                                                <div>
                                                                    <p className="font-black text-sm text-slate-200">{player.name}</p>
                                                                    <p className="text-xs text-slate-500">{player.rank === 1 ? "Gold" : player.rank === 2 ? "Silver" : player.rank === 3 ? "Bronze" : "Player"}</p>
                                                                </div>
                                                            </div>
                                                            <span className={`font-black text-sm ${player.rank === 1 ? "text-yellow-400" : player.rank === 2 ? "text-gray-300" : player.rank === 3 ? "text-orange-400" : "text-cyan-400"}`}>{player.coins.toLocaleString()}</span>
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    </div>

                                    {/* CENTER PANEL - HERO (PERFECTLY CENTERED) */}
                                    <div style={{display: 'flex', alignItems: 'center', justifyContent: 'center', minHeight: '500px'}}>
                                        <div className="w-full max-w-[600px] backdrop-blur-xl border border-cyan-500/30 bg-gradient-to-b from-slate-900/50 to-slate-950/80 rounded-3xl p-12 shadow-2xl shadow-cyan-500/20 hover:shadow-cyan-500/40 transition-all duration-300 relative overflow-hidden group">

                                            {/* GLOW ANIMATION */}
                                            <div className="absolute top-0 left-1/2 -translate-x-1/2 -translate-y-1/2 w-80 h-80 bg-cyan-500/20 rounded-full filter blur-3xl group-hover:bg-cyan-500/40 transition-all duration-300 pointer-events-none" />

                                            <div className="relative z-10 text-center space-y-6">

                                                <p className="text-slate-300 italic text-sm leading-relaxed max-w-sm">üèúÔ∏è X√¢y d·ª±ng l·ªô tr√¨nh n∆∞·ªõc xuy√™n qua sa m·∫°c c√°ch, kh√°m ph√° kho t√†ng 30+ xu ·∫©n gi·∫•u!</p>

                                                {/* GIANT PLAY BUTTON */}
                                                <button
                                                    onClick={() => {playSound("click", 0.5);const hasSave = loadGame();if(!hasSave){ generatePuzzle(false)};}}
                                                    className="group/btn w-64 py-5 rounded-2xl text-2xl font-black uppercase bg-gradient-to-r from-cyan-500 via-blue-500 to-cyan-600 text-black transition-all duration-300 hover:shadow-2xl hover:shadow-cyan-500/60 active:scale-95 hover:scale-105 relative overflow-hidden mx-auto block"
                                                >
                                                    <div className="absolute inset-0 bg-white/20 opacity-0 group-hover/btn:opacity-100 transition-opacity duration-300" />
                                                    <span className="relative flex items-center justify-center gap-3">
                                                        CH∆†I NGAY <span className="text-xl">üõ†Ô∏è</span>
                                                    </span>
                                                    <div className="absolute inset-0 rounded-2xl opacity-0 group-hover/btn:opacity-100 group-hover/btn:animate-pulse border-2 border-white/80 pointer-events-none" />
                                                </button>

                                                {/* GIFTCODE INPUT */}
                                                <div className="pt-6 border-t border-cyan-500/20 space-y-3">
                                                    <p className="text-xs font-black text-slate-500 uppercase tracking-widest">Nh·∫≠p Giftcode</p>
                                                    <div className="flex gap-2">
                                                        <input
                                                            type="text"
                                                            value={giftCodeInput}
                                                            onChange={(e) => setGiftCodeInput(e.target.value)}
                                                            placeholder="GIFTCODE"
                                                            className="flex-1 bg-slate-900/80 border border-cyan-500/30 rounded-xl px-4 py-3 uppercase font-black text-sm tracking-widest text-cyan-300 placeholder:text-slate-600 focus:outline-none focus:border-cyan-500/60 focus:shadow-lg focus:shadow-cyan-500/20 transition-all duration-300"
                                                        />
                                                        <button
                                                            onClick={() => {playSound("click", 0.5); handleRedeemGiftcode();}}
                                                            className="bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-500 hover:to-pink-500 px-6 py-3 rounded-xl font-black transition-all duration-300 hover:shadow-lg hover:shadow-purple-500/50 active:scale-95 text-sm uppercase"
                                                        >
                                                            Nh·∫≠n
                                                        </button>
                                                    </div>
                                                    <p className="text-[10px] text-slate-600 font-bold uppercase text-center pt-2">
                                                        Th·ª≠: <span className="text-cyan-400">PIPEMASTER</span> ‚Ä¢ <span className="text-green-400">NEWGAME</span> ‚Ä¢ <span className="text-yellow-400">FREE800</span>
                                                    </p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    {/* RIGHT PANEL - MISSIONS WITH FLIP */}
                                    <div className="space-y-4">
                                        <div className="backdrop-blur-xl border border-cyan-500/20 bg-gradient-to-br from-slate-900/40 to-slate-950/60 rounded-3xl p-6 shadow-2xl shadow-cyan-500/10 hover:shadow-cyan-500/20 transition-all duration-300">
                                            {/* MISSION TABS WITH COUNTDOWN */}
                                            <div className="flex gap-2 mb-6">
                                                <button
                                                    onClick={() => {playSound("click", 0.5); setMissionView("daily");}}
                                                    className={`flex-1 py-2 px-3 rounded-lg font-black text-xs uppercase transition-all duration-300 ${missionView === "daily" ? "bg-gradient-to-r from-orange-500 to-yellow-500 text-black shadow-lg shadow-orange-500/50" : "bg-slate-700/50 text-slate-300 hover:bg-slate-700/70 border border-orange-500/20"}`}
                                                >
                                                    <div>üìÖ H√¥m Nay</div>
                                                    <div className="text-[9px] opacity-80 font-mono">{remainingDaily}</div>
                                                </button>
                                                <button
                                                    onClick={() => {playSound("click", 0.5); setMissionView("weekly");}}
                                                    className={`flex-1 py-2 px-3 rounded-lg font-black text-xs uppercase transition-all duration-300 ${missionView === "weekly" ? "bg-gradient-to-r from-purple-500 to-pink-500 text-white shadow-lg shadow-purple-500/50" : "bg-slate-700/50 text-slate-300 hover:bg-slate-700/70 border border-purple-500/20"}`}
                                                >
                                                    <div>üéØ Tu·∫ßn</div>
                                                    <div className="text-[9px] opacity-80 font-mono">{remainingWeekly}</div>
                                                </button>
                                            </div>

                                            {/* MISSIONS CONTAINER WITH FLIP */}
                                            <div style={{perspective: '1000px', minHeight: '300px', position: 'relative'}}>
                                                <div style={{
                                                    transformStyle: 'preserve-3d',
                                                    transition: 'transform 0.6s ease-in-out',
                                                    transform: missionView === 'weekly' ? 'rotateY(180deg)' : 'rotateY(0deg)',
                                                    width: '100%',
                                                    position: 'relative'
                                                }}>
                                                    {/* DAILY MISSIONS - FRONT */}
                                                    <div style={{backfaceVisibility: 'hidden', display: 'flex', flexDirection: 'column', alignItems: 'flex-start', justifyContent: 'flex-start', width: '100%', position: 'relative', zIndex: missionView === 'daily' ? 1 : 0}}>
                                                        <div className="space-y-3 w-full">
                                                            {dailyMissions.map((mission) => (
                                                                <div key={mission.id} className="bg-orange-500/5 border border-orange-500/20 rounded-2xl p-3 hover:border-orange-500/40 transition-all duration-300 group/mission hover:shadow-lg hover:shadow-orange-500/10 transform hover:translateY-1 w-full">
                                                                    <div className="flex justify-between items-center mb-2">
                                                                        <p className="text-xs font-bold text-slate-300">{mission.title}</p>
                                                                        <span className="text-xs font-black text-orange-400">+{mission.reward}</span>
                                                                    </div>
                                                                    <div className="w-full bg-slate-900/60 rounded-full h-2 mb-2 overflow-hidden border border-orange-500/20">
                                                                        <div className="bg-gradient-to-r from-orange-400 to-yellow-500 h-2 rounded-full transition-all duration-500" style={{width: `${(mission.progress / mission.target) * 100}%`}} />
                                                                    </div>
                                                                    <button
                                                                        onClick={() => {playSound("click", 0.5); claimMission(mission.id, false);}}
                                                                        disabled={mission.claimed || mission.progress < mission.target}
                                                                        className={`w-full py-1.5 rounded-lg text-xs font-black uppercase transition-all duration-300 ${mission.claimed ? "bg-slate-700/60 text-slate-500 opacity-50 cursor-not-allowed" : mission.progress < mission.target ? "bg-slate-700/60 text-slate-500 opacity-75 cursor-not-allowed" : "bg-gradient-to-r from-orange-500 to-yellow-500 text-black hover:shadow-lg hover:shadow-orange-500/50 active:scale-95 hover:scale-105"}`}
                                                                    >
                                                                        {mission.claimed ? "‚úì ƒê√£ nh·∫≠n" : mission.progress < mission.target ? `${mission.progress}/${mission.target}` : "Nh·∫≠n"}
                                                                    </button>
                                                                </div>
                                                            ))}
                                                        </div>
                                                    </div>

                                                    {/* WEEKLY MISSIONS - BACK (FLIPPED) */}
                                                    <div style={{backfaceVisibility: 'hidden', transform: 'rotateY(180deg)', display: 'flex', flexDirection: 'column', alignItems: 'flex-start', justifyContent: 'flex-start', width: '100%', position: 'absolute', top: 0, left: 0, zIndex: missionView === 'weekly' ? 1 : 0}}>
                                                        <div className="space-y-3 w-full">
                                                            {weeklyMissions.map((mission) => (
                                                                <div key={mission.id} className="bg-purple-500/5 border border-purple-500/20 rounded-2xl p-3 hover:border-purple-500/40 transition-all duration-300 group/mission hover:shadow-lg hover:shadow-purple-500/10 transform hover:translateY-1 w-full">
                                                                    <div className="flex justify-between items-center mb-2">
                                                                        <p className="text-xs font-bold text-slate-300">{mission.title}</p>
                                                                        <span className="text-xs font-black text-purple-400">+{mission.reward}</span>
                                                                    </div>
                                                                    <div className="w-full bg-slate-900/60 rounded-full h-2 mb-2 overflow-hidden border border-purple-500/20">
                                                                        <div className="bg-gradient-to-r from-purple-400 to-pink-500 h-2 rounded-full transition-all duration-500" style={{width: `${(mission.progress / mission.target) * 100}%`}} />
                                                                    </div>
                                                                    <button
                                                                        onClick={() => {playSound("click", 0.5); claimMission(mission.id, true);}}
                                                                        disabled={mission.claimed || mission.progress < mission.target}
                                                                        className={`w-full py-1.5 rounded-lg text-xs font-black uppercase transition-all duration-300 ${mission.claimed ? "bg-slate-700/60 text-slate-500 opacity-50 cursor-not-allowed" : mission.progress < mission.target ? "bg-slate-700/60 text-slate-500 opacity-75 cursor-not-allowed" : "bg-gradient-to-r from-purple-500 to-pink-500 text-white hover:shadow-lg hover:shadow-purple-500/50 active:scale-95 hover:scale-105"}`}
                                                                    >
                                                                        {mission.claimed ? "‚úì ƒê√£ nh·∫≠n" : mission.progress < mission.target ? `${mission.progress}/${mission.target}` : "Nh·∫≠n"}
                                                                    </button>
                                                                </div>
                                                            ))}
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                </div>
                            </div>
                        </div>
                    ) : (
                        <div className="game-full-overlay">
                            {isTutorial && (
                                <div className="tutorial-banner">
                                    <span className="text-lg">üëá</span>
                                    <span>H√ÄNH ƒê·ªòNG: CLICK V√ÄO √î ƒê√Å ƒêANG NH·∫§P NH√ÅY ƒê·ªÇ PH√Å ƒê√Å!</span>
                                    <span className="text-lg">‚õèÔ∏è</span>
                                </div>
                            )}

                            {/* AI LOG PANEL - RIGHT SIDE */}
                            {isAIVisible && (
                                <div className="fixed right-0 top-24 bottom-0 w-80 bg-slate-950/95 border-l border-cyan-500/30 backdrop-blur-xl overflow-hidden flex flex-col z-[100]">
                                    <div className="p-4 border-b border-cyan-500/20 bg-gradient-to-r from-cyan-500/20 to-blue-500/10">
                                        <h3 className="font-black text-cyan-300 uppercase text-sm tracking-tight">ü§ñ AI SOLVER LOG</h3>
                                        <p className="text-[10px] text-cyan-400/70 mt-1">Real-time execution trace</p>
                                    </div>

                                    <div className="flex-1 overflow-y-auto p-4 space-y-2">
                                        {aiLogs && aiLogs.length > 0 ? (
                                            aiLogs.map((log, idx) => (
                                                <div key={idx} className="bg-slate-900/70 border border-cyan-500/20 rounded-lg p-3 hover:border-cyan-500/40 transition-all text-sm animate-in fade-in slide-in-from-right-4 duration-300">
                                                    <div className="flex justify-between items-start gap-2 mb-1">
                                                        <span className="text-cyan-400 font-black text-xs">{typeof log === 'string' ? '‚ñ∏' : log.time}</span>
                                                        {typeof log === 'string' && <span className="text-cyan-300 flex-1">{log}</span>}
                                                    </div>
                                                    {typeof log !== 'string' && (
                                                        <p className="text-slate-300 text-xs leading-relaxed">{log.text}</p>
                                                    )}
                                                </div>
                                            ))
                                        ) : (
                                            <div className="text-center text-slate-500 text-sm py-6">Waiting for AI...</div>
                                        )}
                                    </div>

                                    <div className="p-3 border-t border-cyan-500/20 bg-slate-900/50 text-[10px] text-slate-400 space-y-1">
                                        <div>‚õèÔ∏è Shovels: {shovelCount}</div>
                                        <div>üí∞ Coins: {sessionCoins}</div>
                                        <div>üìä Status: {isWon ? 'üéâ WON' : isLost ? 'üíÄ LOST' : '‚ñ∂ RUNNING'}</div>
                                    </div>
                                </div>
                            )}

                            <div className="h-20 px-8 flex items-center justify-between bg-slate-900/95 border-b border-white/10">
                                <div className="relative">
                                    <button 
                                        onClick={() => {playSound("click", 0.5); setIsMenuOpen(!isMenuOpen);}} 
                                        className="w-10 h-10 flex flex-col items-center justify-center gap-1.5 group"
                                    >
                                        <div className="w-6 h-0.5 bg-slate-400 group-hover:bg-cyan-400 transition-colors"></div>
                                        <div className="w-6 h-0.5 bg-slate-400 group-hover:bg-cyan-400 transition-colors"></div>
                                        <div className="w-6 h-0.5 bg-slate-400 group-hover:bg-cyan-400 transition-colors"></div>
                                    </button>

                                    {isMenuOpen && (
                                        <>
                                            <div className="fixed inset-0 z-[1001]" onClick={() => setIsMenuOpen(false)}></div>
                                            <div className="absolute top-12 left-0 w-48 glass-card border-white/10 shadow-2xl z-[1002] p-2 animate-in fade-in slide-in-from-top-2 duration-200">
                                                <button onClick={() => {playSound("click", 0.5); stopGameplay(); playBackground(); saveGame();}} className="menu-item">
                                                    <span>üíæ</span> L∆∞u tr·∫≠n
                                                </button>
                                                <button onClick={() => {playSound("click", 0.5); generatePuzzle(false);}} className="menu-item">
                                                    <span>üîÑ</span> Ch∆°i l·∫°i
                                                </button>
                                                <button onClick={() => {playSound("click", 0.5); toggleAI();}} className="menu-item">
                                                    <span>ü§ñ</span> AI
                                                </button>
                                                <div className="h-px bg-white/5 my-1"></div>
                                               <button
                                                    onClick={() => {
                                                        playSound("click", 0.5);

                                                        if (!hasSaved) {
                                                            // x√≥a save c·ªßa player n√†y
                                                            localStorage.removeItem(getSaveKey(playerName));

                                                            // reset to√†n b·ªô tr·∫°ng th√°i tr·∫≠n hi·ªán t·∫°i
                                                            setGameGrid([]);
                                                            setSessionCoins(0);
                                                            setShovelCount(0);

                                                            // reset tutorial ƒë·ªÉ l·∫ßn sau hi·ªán l·∫°i
                                                            setIsTutorial(false);
                                                            setShowTutorialModal(false);
                                                        }

                                                        // ƒë√≥ng menu v√† v·ªÅ m√†n h√¨nh ch√≠nh
                                                        setIsMenuOpen(false);
                                                        setIsPlaying(false);
                                                    }}
                                                    className="menu-item"
                                                    >
                                                    <span>üö™</span> Tho√°t
                                                    </button>
                                            </div>
                                        </>
                                    )}
                                </div>

                                <div className="flex gap-6 items-center">
                                    <div className="text-right">
                                        <div className="text-[10px] text-slate-500 font-black uppercase">Xu tr·∫≠n</div>
                                        <div className="text-lg font-black text-cyan-400">{sessionCoins}</div>
                                    </div>
                                    <div className="text-right">
                                        <div className="text-[10px] text-slate-500 font-black uppercase">X·∫ªng</div>
                                        <div className="text-lg font-black text-white">‚õèÔ∏è {shovelCount}</div>
                                    </div>
                                    <button onClick={() => {playSound("click", 0.5);setIsShopOpen(true);}} className="px-5 py-2 rounded-xl border border-cyan-500/50 bg-slate-800 text-cyan-400 font-black uppercase text-xs hover:bg-cyan-500 hover:text-black transition-colors">üõí SHOP / HINT</button>
                                </div>
                            </div>

                            {showTutorialModal && (
                                <div className="fixed inset-0 z-[1000] bg-black/70 backdrop-blur-md flex items-center justify-center p-6">
                                    <div className="glass-card p-8 max-w-md w-full border-cyan-500/40 text-center">
                                        <div className="text-5xl mb-4">üìñ</div>
                                        <h3 className="text-2xl font-black text-cyan-400 uppercase mb-4 tracking-tighter italic">H∆Ø·ªöNG D·∫™N C∆† B·∫¢N</h3>
                                        <div className="space-y-4 text-left text-slate-300 text-sm mb-8 leading-relaxed">
                                            <p className="flex gap-3"><span className="text-cyan-400 font-bold">1.</span> Click v√†o √¥ ü™® (ƒê√°) ƒë·ªÉ d√πng ‚õèÔ∏è (X·∫ªng) ph√° n√≥. C√≥ 30 ƒë·ªìng xu ü™ô ƒëang ·∫©n gi·∫•u!</p>
                                            <p className="flex gap-3"><span className="text-cyan-400 font-bold">2.</span> N∆∞·ªõc ch·∫£y qua √¥ c√≥ xu s·∫Ω t·ª± ƒë·ªông thu th·∫≠p v√†o qu·ªπ xu tr·∫≠n ƒë·∫•u.</p>
                                            <p className="flex gap-3"><span className="text-cyan-400 font-bold">3.</span> D√πng xu nh·∫∑t ƒë∆∞·ª£c ƒë·ªÉ mua th√™m x·∫ªng trong Shop n·∫øu b·ªã k·∫πt.</p>
                                            <div className="bg-orange-500/20 border border-orange-500/40 p-3 rounded-lg mt-2">
                                                <p className="text-orange-400 font-bold text-center">üéØ B·∫Øt ƒë·∫ßu b·∫±ng c√°ch click v√†o √¥ ƒë√° ƒêANG NH·∫§P NH√ÅY!</p>
                                            </div>
                                        </div>
                                        <button 
                                            onClick={() => {playSound("click", 0.5); setShowTutorialModal(false);}}
                                            className="play-button w-full py-4 rounded-xl font-black uppercase shadow-lg shadow-cyan-500/20"
                                        >T√îI ƒê√É HI·ªÇU!</button>
                                    </div>
                                </div>
                            )}

                            {isShopOpen && (
                                <div className="fixed inset-0 z-[100] bg-black/80 backdrop-blur-sm flex items-center justify-center p-6">
                                    <div className="glass-card p-8 max-w-md w-full border-cyan-500/40 relative">
                                        <button onClick={() => {
                                                            playSound("click", 0.5);setIsShopOpen(false);}} className="absolute top-4 right-4 text-slate-500 hover:text-white text-2xl">&times;</button>
                                        <h3 className="text-2xl font-black text-cyan-500 uppercase italic mb-6">C·ª≠a h√†ng Tr·∫≠n ƒë·∫•u</h3>
                                        <div className="space-y-6">
                                            <div className="bg-slate-800/50 p-4 rounded-2xl border border-white/5">
                                                <div className="flex justify-between items-center mb-3">
                                                    <span className="font-bold text-sm text-slate-300">‚õèÔ∏è Mua X·∫ªng</span>
                                                    <span className="text-xs text-slate-500">{SHOVEL_PRICE} xu / c√°i</span>
                                                </div>
                                                <div className="flex items-center gap-3">
                                                    <button onClick={() => {playSound("click", 0.5); setBuyQuantity(q => Math.max(1, q - 1))}} className="w-10 h-10 rounded-lg bg-slate-700 flex items-center justify-center font-black text-xl hover:bg-slate-600">-</button>
                                                    <input type="number" value={buyQuantity} onChange={(e) => setBuyQuantity(Math.max(1, parseInt(e.target.value) || 0))} className="flex-1 bg-slate-900 border border-white/10 rounded-lg h-10 text-center font-black text-cyan-400 quantity-input" />
                                                    <button onClick={() => {playSound("click", 0.5); setBuyQuantity(q => q + 1)}} className="w-10 h-10 rounded-lg bg-slate-700 flex items-center justify-center font-black text-xl hover:bg-slate-600">+</button>
                                                </div>
                                                <button onClick={() => {playSound("click", 0.5); buyShovels();}} disabled={!canAfford} className={`w-full mt-4 py-3 font-black rounded-xl uppercase text-xs transition-all ${canAfford ? "bg-gradient-to-r from-cyan-500 to-blue-600 text-black shadow-lg shadow-cyan-500/20 active:scale-[0.98]" : "bg-slate-700 text-slate-500 cursor-not-allowed opacity-50"}`}>
                                                    {canAfford ? `Thanh to√°n: ${(buyQuantity * SHOVEL_PRICE).toLocaleString()} ü™ô` : `Thi·∫øu ${(buyQuantity * SHOVEL_PRICE - sessionCoins).toLocaleString()} xu`}
                                                </button>
                                            </div>
                                            <div className="border-t border-white/10 pt-4">
                                                <button onClick={() => { playHintBreak(); handleFlushHint();}} disabled={sessionCoins < 50} className="hint-btn">
                                                    <span className="text-xs uppercase opacity-70">T·ª± ƒë·ªông x·∫£ g√≥i cao nh·∫•t</span>
                                                    <span className="text-base">üöÄ K√çCH  HO·∫†T FLUSH HINT</span>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            )}

                            <div className="flex-1 flex items-center justify-center p-8 bg-slate-950 min-w-0">

                                <div className="rainbow-border border-2 rounded-2xl overflow-hidden bg-slate-900/50 shadow-2xl w-full h-full">
                                    <div className="pipe-grid" style={{ gridTemplateColumns: `repeat(${GRID_SIZE}, 1fr)` }}>
                                    {gameGrid.map((row, r) => row.map((pipe, c) => (
                                        <div key={`${r}-${c}`} className={`pipe-cell ${pipe.type === 'DIRT' ? 'is-dirt' : ''} ${pipe.isTutorialBlock && isTutorial ? 'tutorial-highlight' : ''} ${highlightedCells.includes(`${r}-${c}`) ? 'hint-flash' : ''}`}
                                    onClick={() => {

    const pipe = gameGrid[r][c];

    // n·∫øu l√† ƒë·∫•t trong tutorial
    if (pipe.type === "DIRT" && isTutorial) {

        // kh√¥ng ph·∫£i block ƒë√∫ng ‚Üí ch·∫∑n
        if (!pipe.isTutorialBlock) {

            showToast("‚ö†Ô∏è PH·∫¢I PH√Å KH·ªêI ƒê∆Ø·ª¢C H∆Ø·ªöNG D·∫™N!", "warning");

            return;
        }
    }

    // g·ªçi logic g·ªëc (ph√° ƒë·∫•t ho·∫∑c xoay pipe)
    rotatePipe(r, c);

}}>
                                            {pipe.hasCoin && (
                                                <div className="coin-float">
                                                    <svg viewBox="0 0 100 100"><circle cx="50" cy="50" r="40" fill="#fbbf24" stroke="#d97706" strokeWidth="8"/><text x="50" y="65" textAnchor="middle" fontSize="40" fontWeight="bold" fill="#d97706">C</text></svg>
                                                </div>
                                            )}
                                            {pipe.type === 'DIRT' ? (
                                                <div className="text-lg md:text-xl relative">
                                                    ü™®
                                                    {pipe.isTutorialBlock && isTutorial && (
                                                        <div className="absolute top-8 left-1/2 -translate-x-1/2 bg-orange-500 text-black px-2 py-1 rounded text-[10px] font-black whitespace-nowrap animate-bounce shadow-lg">CLICK ƒê·ªÇ PH√Å!</div>
                                                    )}
                                                </div>
                                            ) : (
                                                <svg viewBox="0 0 100 100" className="pipe-svg" style={{ transform: `rotate(${pipe.rotation * 90}deg)` }}>
                                                    <g fill="none" className={pipe.active ? "pipe-active" : "pipe-inactive"}>
                                                        {pipe.type === 'SOURCE' && <g><rect x="10" y="30" width="30" height="40" rx="4" fill="currentColor"/><path d="M40 50 L100 50" className={pipe.active ? "flowing" : ""}/></g>}
                                                        {pipe.type === 'SINK' && (
                                                            <g>
                                                                <circle cx="50" cy="50" r="42" stroke="currentColor" strokeWidth="4" strokeDasharray="4 4" opacity="0.3"/>
                                                                <path d="M0 50 L30 50" className={pipe.active ? "flowing" : ""}/>
                                                                <g className={pipe.active ? "sink-valve-active text-cyan-400" : "text-slate-600"}>
                                                                    <circle cx="50" cy="50" r="30" stroke="currentColor" strokeWidth="6"/>
                                                                    <path d="M50 20 L50 80 M20 50 L80 50" stroke="currentColor" strokeWidth="4"/>
                                                                    <circle cx="50" cy="50" r="8" fill="currentColor"/>
                                                                    <circle cx="50" cy="20" r="4" fill="currentColor"/>
                                                                    <circle cx="50" cy="80" r="4" fill="currentColor"/>
                                                                    <circle cx="20" cy="50" r="4" fill="currentColor"/>
                                                                    <circle cx="80" cy="50" r="4" fill="currentColor"/>
                                                                </g>
                                                            </g>
                                                        )}
                                                        {pipe.type === 'STRAIGHT' && <path d="M0 50 L100 50" className={pipe.active ? "flowing" : ""}/>}
                                                        {pipe.type === 'ELBOW' && <path d="M50 100 Q50 50 100 50" className={pipe.active ? "flowing" : ""}/>}
                                                        {pipe.type === 'TEE' && <g><path d="M0 50 L100 50"/><path d="M50 50 L50 100" className={pipe.active ? "flowing" : ""}/></g>}
                                                        {pipe.type === 'CROSS' && <g><path d="M0 50 L100 50"/><path d="M50 0 L50 100" className={pipe.active ? "flowing" : ""}/></g>}
                                                    </g>
                                                </svg>
                                            )}
                                        </div>
                                    )))}
                                </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {isWon && (
                        <div className="fixed inset-0 z-[10001] bg-black/95 flex items-center justify-center p-6 text-center">
                            <div className="glass-card p-12 max-w-md w-full border-2 border-cyan-500">
                                <div className="text-7xl mb-6">üèÜ</div>
                                <h2 className="text-4xl font-black text-cyan-400 mb-8 uppercase italic">CHI·∫æN TH·∫ÆNG!</h2>
                                <button
                                    onClick={() => {

                                        playSound("win", 0.5);

                                        stopGameplay();
                                        playBackground();

                                        // c·ªông coin v√†o t√†i kho·∫£n ch√≠nh
                                        const reward = sessionCoins + WIN_BONUS;
                                        setTotalCoins(prev => prev + reward);

                                        // UPDATE MISSIONS
                                        updateMissionProgress("d1", 1, false); // Ch∆°i 1 tr·∫≠n
                                        updateMissionProgress("w1", 1, true);  // Th·∫Øng 3 tr·∫≠n
                                        updateMissionProgress("d2", reward, false); // Thu th·∫≠p 500 xu
                                        updateMissionProgress("w2", reward, true);  // Thu th·∫≠p 3000 xu

                                        // reset tr·∫°ng th√°i
                                        setSessionCoins(0);
                                        setIsWon(false);
                                        setIsLost(false);

                                        // QUAN TR·ªåNG: quay v·ªÅ menu ch√≠nh
                                        setIsPlaying(false);

                                    }}
                                    className="play-button w-full py-5 rounded-2xl font-black text-xl text-black"
                                >
                                    <span> NH·∫¨N {sessionCoins + WIN_BONUS} ü™ô</span>
                                </button>
                            </div>
                        </div>
                    )}

                    {isLost && (
                        <div className="fixed inset-0 z-[10001] bg-black/95 flex items-center justify-center p-6 text-center">
                            <div className="glass-card p-12 max-w-md w-full border-2 border-red-500">
                                <div className="text-7xl mb-6">üíÄ</div>
                                <h2 className="text-4xl font-black text-red-500 mb-4 uppercase italic">GAME OVER</h2>
                                <p className="text-slate-400 mb-8 text-sm italic">B·∫°n ƒë√£ h·∫øt s·∫°ch x·∫ªng v√† kh√¥ng c√≤n xu n√†o tr√™n b·∫£n ƒë·ªì ƒë·ªÉ thu th·∫≠p!</p>
                                <button
onClick={() => {

    playSound("click", 0.5);

    stopGameplay();
    playBackground();

    // x√≥a save
    localStorage.removeItem(getSaveKey(playerName));

    // reset tr·∫°ng th√°i
    setIsLost(false);
    setIsWon(false);

    // t·∫°o map m·ªõi
    generatePuzzle(false);

}}
className="play-button w-full py-5 rounded-2xl font-black text-xl text-black bg-gradient-to-r from-red-500 to-orange-500"
>
TH·ª¨ L·∫†I M√ÄN M·ªöI
</button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>